rules_version = '2'
service cloud.firestore {
  match /databases/{database}/documents {

    function isLoggedIn() {
        return request.auth.uid != null;
    }

    function isOwner(ownerId) {
        return isLoggedIn() && request.auth.uid == ownerId;
    }

    function hasRequiredFields(requiredFields) {
        return request.resource.data.keys().hasAll(requiredFields);
    }

    function verifyUnchangedFields(fields) {
        return resource == null || !request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }

    function verifyTimestamp(time) {
        return request.time.toMillis() - time < 5000 && request.time.toMillis() - time > 0;
    }

    function isString(field) {
        return !(field in request.resource.data) || request.resource.data[field] is string;
    }

    function isNumber(field) {
        return !(field in request.resource.data) || request.resource.data[field] is number;
    }

    function isBoolean(field) {
        return !(field in request.resource.data) || request.resource.data[field] is bool;
    }

    function validateStringMaxSize(field, maxSize) {
        return !(field in request.resource.data)
            || (request.resource.data[field] is string && request.resource.data[field].size() <= maxSize);
    }

    function validateStringMinSize(field, minSize) {
        return request.resource.data[field] is string && request.resource.data[field].size() >= minSize;
    }

    match /{document=**} {
        allow read, write: if false;
    }

    match /users/{userId} {
        function validateFields() {
            return validateStringMaxSize("email", 50) && validateStringMaxSize("username", 25) && validateStringMinSize("username", 3) && isString("avatar");
        }

        allow read: if isLoggedIn();
        allow create: if isOwner(userId) && hasRequiredFields(["email", "username"]) && validateFields() && request.auth.token.email == request.resource.data.email;
        allow update: if isOwner(userId) && hasRequiredFields(["email", "username"]) && validateFields() && verifyUnchangedFields(["email"]);
        allow delete: if false;
    }

    match /tests/{testId} {
        function getAuthor() {
            return get(/databases/$(database)/documents/tests/$(testId)).data.author;
        }

        function validateFields() {
            return isString("author") && validateStringMaxSize("title", 75) && isString("category") && isNumber("lastUpdated")
                && validateStringMaxSize("description", 1000) && isString("image") && isBoolean("isPasswordEnabled") && isBoolean("isPublished")
                && isBoolean("isLinkEnabled") && isString("link") && isBoolean("isNavigationEnabled")
                && isBoolean("isRandomQuestions") && isBoolean("isRandomAnswers")
                && isNumber("pointsMax") && isNumber("questionsNum") && isBoolean("isGradesEnabled");
        }

        allow get: if true;
        allow list: if isLoggedIn();
        allow create, update: if isOwner(request.resource.data.author) && hasRequiredFields(["author", "title", "category", "lastUpdated"])
            && verifyUnchangedFields(["author"]) && verifyTimestamp(request.resource.data.lastUpdated) && validateFields();
        allow delete: if isOwner(resource.data.author);

        match /private/{document=**} {
            allow read, write: if isOwner(getAuthor());
        }
    }

    match /testsPassed/{recordId} {
        function getAuthor(testId) {
            return get(/databases/$(database)/documents/tests/$(testId)).data.author;
        }

        function validateFields() {
            return isString("user") && isString("testId") && validateStringMaxSize("title", 75) && isNumber("timeStarted")
                && isNumber("timeFinished") && isBoolean("isFinished") && isNumber("pointsMax") && isNumber("pointsEarned")
                && isString("image") && isBoolean("isGradesEnabled");
        }

        allow read: if isOwner(resource.data.user) || isOwner(getAuthor(resource.data.testId));
        allow create: if false; // cloud functions only
        allow update: if isOwner(resource.data.user) && !resource.data.isFinished
            && hasRequiredFields(["user", "testId", "title", "questions", "timeStarted", "timeFinished", "isFinished", "pointsMax"])
            && verifyUnchangedFields(["user", "testId", "title", "timeStarted", "isFinished", "pointsMax", "isGradesEnabled", "grades"])
            && verifyTimestamp(request.resource.data.timeFinished) && validateFields();
        allow delete: if false;

        match /private/{document=**} {

            function canRead() {
                let data = get(/databases/$(database)/documents/testsPassed/$(recordId)).data;
                let isCorrectAnswersShown = get(/databases/$(database)/documents/tests/$(testId)).data.isCorrectAnswersShown;

                return (!data.isDemo && isOwner(getAuthor(data.testId))) || ((data.isFinished || data.pointsCalculated) && isCorrectAnswersShown);
            }

            allow read: if canRead();
            allow write: if false; // cloud functions only
        }
    }
  }
}